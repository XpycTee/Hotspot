{% extends 'base.html' %}

{% block title %}
Panel
{% endblock %}

{% block content %}
<div class="admin-dashboard">
    <a href="{{ url_for('admin.logout') }}" class="btn btn-exit">Выход</a>
    <ul class="nav-tabs">
        <li><a href="#tab1">WiFi Clients</a></li>
        <li><a href="#tab2">Employees list</a></li>
        <li><a href="#tab3">Blacklist</a></li>
    </ul>
    <div class="table-container">
        <div id="tab1" class="content-tab table-container">
            <table>
                <thead>
                    <tr>
                        <th>Mac Address</th>
                        <th>Expiration</th>
                        <th>Is Employee</th>
                        <th>Phone Number</th>
                    </tr>
                </thead>
                <tbody>
                    {% for client in wifi_clients %}
                    <tr>
                        <td>{{ client.get('mac') }}</td>
                        <td>{{ client.get('expiration') }}</td>
                        <td>{{ client.get('employee') }}</td>
                        <td>{{ client.get('phone') }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <div id="tab2" class="content-tab table-container" style="display: none;">
            <table>
                <thead>
                    <tr>
                        <th>Lastname</th>
                        <th>Name</th>
                        <th>Phones</th>
                        <th class="column-controls">Controls</th>
                    </tr>
                </thead>
                <tbody>
                    {% for employee in employees %}
                    <tr>
                        <td data-lastname>{{ employee.get('lastname') }}</td>
                        <td data-name>{{ employee.get('name') }}</td>
                         <td data-phones>
                            <ul>
                                {% for phone in employee.get('phone') %}
                                <li>{{ phone }}</li>
                                {% endfor %}
                            </ul>
                        </td>
                        <td class="column-controls">
                            <button class="btn btn-edit btn-controls" onclick="editRow(this)">Edit</button>
                            <button class="btn btn-delete btn-controls" onclick="deleteRow(this)">Delete</button>
                        </td>
                    </tr>
                    {% endfor %}
                    <tr>
                        <td colspan="4"><button class="btn btn-add" onclick="addRow(this)">Добавить</button></td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div id="tab3" class="content-tab table-container" style="display: none;">
            <table>
                <thead>
                    <tr>
                        <th>Phone</th>
                        <th class="column-controls">Controls</th>
                    </tr>
                </thead>
                <tbody>
                    {% for blocked in blacklist %}
                    <tr>
                        <td class="blocked-phone">{{ blocked }}</td>
                        <td class="column-controls">
                            <button class="btn btn-delete btn-controls" onclick="deleteRow(this)">Delete</button>
                        </td>
                    </tr>
                    {% endfor %}
                    <tr>
                        <td colspan="2"><button class="btn btn-add" onclick="addRow(this)">Добавить</button></td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

</div>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const tabs = document.querySelectorAll('.nav-tabs a');
        const contentTabs = document.querySelectorAll('.content-tab');

        // Hide all content tabs initially
        contentTabs.forEach(content => content.style.display = 'none');

        // Check localStorage for saved tab
        const savedTab = localStorage.getItem('activeTab');
        if (savedTab) {
            document.querySelector(savedTab).style.display = 'block';
            document.querySelector(`.nav-tabs a[href="${savedTab}"]`).classList.add('active');
        } else {
            // Default to first tab if no saved tab
            contentTabs[0].style.display = 'block';
            tabs[0].classList.add('active');
        }

        tabs.forEach(tab => {
            tab.addEventListener('click', function (e) {
                e.preventDefault();
                const target = this.getAttribute('href');

                // Hide all content tabs
                contentTabs.forEach(content => content.style.display = 'none');
                // Show the selected tab content
                document.querySelector(target).style.display = 'block';

                // Remove active class from all tabs
                tabs.forEach(link => link.classList.remove('active'));
                // Add active class to the clicked tab
                this.classList.add('active');

                // Save the active tab to localStorage
                localStorage.setItem('activeTab', target);
            });
        });
    });
</script>
<script>
    function addRow(button) {
        const tableBody = button.closest('table').querySelector('tbody');
        const addButtonRow = button.closest('tr');
        const newRow = document.createElement('tr');

        // Determine which table is being modified
        if (tableBody.closest('#tab2')) {
            newRow.innerHTML = `
                <td data-lastname><input type="text" name="lastname" placeholder="Lastname"></td>
                <td data-name><input type="text" name="name" placeholder="Name"></td>
                <td data-phones><input type="text" name="phones" placeholder="Phones"></td>
                <td class="column-controls">
                    <button class="btn btn-save btn-controls" onclick="saveRow(this)">Save</button>
                    <button class="btn btn-delete btn-controls" onclick="deleteRow(this)">Delete</button>
                </td>
            `;
        } else if (tableBody.closest('#tab3')) {
            newRow.innerHTML = `
                <td><input type="text" placeholder="Phone"></td>
                <td class="column-controls">
                    <button class="btn btn-save btn-controls" onclick="saveRow(this)">Save</button>
                    <button class="btn btn-delete btn-controls" onclick="deleteRow(this)">Delete</button>
                </td>
            `;
        }

        // Insert the new row before the row containing the "Add" button
        tableBody.insertBefore(newRow, addButtonRow);
    }
</script>
<script>
    function saveRow(button) {
        const row = button.closest('tr');
        const inputs = row.querySelectorAll('input');
        const data = {};

        // Collect data from inputs
        inputs.forEach(input => {
            const key = input.getAttribute('name') || 'phone';
            data[key] = input.value;
        });

        // Determine which tab is being modified
        let url = '';
        if (row.closest('#tab2')) {
            url = '/admin/save/employee';
        } else if (row.closest('#tab3')) {
            url = '/admin/save/blacklist';
        }

        // Send AJAX request
        fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                // Replace inputs with text
                inputs.forEach(input => {
                    const td = input.closest('td');
                    td.textContent = input.value;
                });
                // Remove save button
                button.remove();
            } else {
                alert('Error saving data');
            }
        })
        .catch(error => console.error('Error:', error));
    }
</script>
<script>
    function deleteRow(button) {
        const row = button.closest('tr');
        const data = {};
        

        // Determine which tab is being modified
        let url = '';
        
        if (row.closest('#tab2')) {
            url = '/admin/delete/employee';
            // Extract lastname and name for identification
            data['lastname'] = row.querySelector('td[data-lastname]').textContent.trim();
            data['name'] = row.querySelector('td[data-name]').textContent.trim();
        } else if (row.closest('#tab3')) {
            url = '/admin/delete/blacklist';
            data['phone'] = row.querySelector('.blocked-phone') ? row.querySelector('.blocked-phone').textContent : null;
        }

        // Send AJAX request
        fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                // Remove row
                row.remove();
            } else {
                alert('Error deleting data');
            }
        })
        .catch(error => console.error('Error:', error));
    }
</script>
{% endblock %}
